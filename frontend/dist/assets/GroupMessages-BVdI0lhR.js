import{e as W,b as x,r as a,a as B,u as G,aB as F,j as s,C as J,c as L,L as O,aQ as q}from"./index-DdC0FHAS.js";import{u as Q,E as V,F as H}from"./emoji-picker-react.esm-G0ikEmzM.js";import{h as w}from"./moment-C5S46NFB.js";const Y=()=>{var y;const{id:l}=W(),{user:t}=x(e=>e.auth),[i,m]=a.useState(""),[g,_]=a.useState([]),{access:h}=x(e=>e.auth),[r,M]=a.useState(null),f=a.useRef(null),[b,$]=a.useState([]),{profile:d}=x(e=>e.profile),R=B(),j=G(),P=a.useRef(null),[v,k]=a.useState(!1),C=()=>{k(!v)},D=e=>{m(i+e.emoji),k(!1)},N=e=>{const c=/(https?:\/\/[^\s]+)/g;return e.split(" ").map((n,u)=>c.test(n)?s.jsx("a",{href:n,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 underline",children:n},u):n+" ")};a.useEffect(()=>{const e=setInterval(()=>{j(F())},24e4);return()=>clearInterval(e)},[j]);const z=()=>{q.get(`http://localhost/api/chat/group-chats/${l}/`,{headers:{Authorization:`Bearer ${h}`}}).then(e=>{var n,u,S,E;M(e.data),console.log((u=(n=e.data)==null?void 0:n.group_chat)==null?void 0:u.users,"groupChat");const c=(E=(S=e.data)==null?void 0:S.group_chat)==null?void 0:E.users.some(T=>T.id===(t==null?void 0:t.pk));console.log(c,"isMember"),console.log(t==null?void 0:t.pk,"user?.pk"),c||R("/group-chat"),_(e.data.messages)}).catch(e=>console.error("Error fetching messages:",e))};a.useEffect(()=>{z()},[l,h]);const{sendJsonMessage:A,lastJsonMessage:o}=Q(`ws://localhost/ws/group-chat/${l}/?token=${h}`,{queryParams:{user_id:t==null?void 0:t.pk},onOpen:()=>console.log("WebSocket connection opened"),onClose:()=>console.log("WebSocket connection closed"),onError:e=>console.log("WebSocket error:",e),shouldReconnect:e=>!0});a.useEffect(()=>{if(o){const e={id:o.id||Date.now(),message:o.body,user:o.user===d.username?d:{username:o.user},created_at:o.created_at||new Date().toISOString()};$(c=>[...c,e])}},[o]);const I=e=>{e.preventDefault(),i.trim()!==""&&(A({event:"send_message",data:{message:i,group_id:l}}),m(""),p())},p=()=>{var e;(e=f.current)==null||e.scrollIntoView({behavior:"smooth"})};return a.useEffect(()=>{p()},[g]),a.useEffect(()=>{p()},[b]),s.jsx(J,{children:s.jsxs("div",{className:"container mx-auto p-4",children:[s.jsxs("h1",{className:"text-3xl font-bold mb-6 border-b pb-4 capitalize ",children:[" ",r==null?void 0:r.group_chat.name]}),((y=r==null?void 0:r.group_chat)==null?void 0:y.admins.length)>0?s.jsxs("div",{className:"flex gap-3 flex-col",children:[s.jsxs("p",{className:"text-gray-700",children:["Admin: ",r.group_chat.admins.map(e=>e.user.username).join(", ")]}),s.jsx(L,{className:" mx-auto hidden w-fit items-center gap-2 self-start rounded-2xl border-b-4 border-blue-500 bg-blue-400 px-5 py-6 font-bold uppercase text-white transition hover:brightness-110 md:flex",variant:"bordered",as:O,to:`/group-chat/${l}/settings`,children:"Group Details"})]}):s.jsx("p",{}),s.jsxs("div",{className:"bg-gray-100 p-4 rounded h-96 overflow-y-auto mb-4",children:[g.map(e=>s.jsx("div",{className:`flex items-start mb-2 ${e.user.id===(t==null?void 0:t.pk)?"justify-end":""}`,children:s.jsxs("div",{children:[s.jsxs("div",{className:`p-2 rounded-lg ${e.user.id!==(t==null?void 0:t.pk)?"bg-green-400 text-white rounded-tl-none":"bg-gray-300 text-black rounded-tr-none"}`,children:[s.jsxs("strong",{children:[e.user.username,": "]}),s.jsx("br",{})," ",N(e.message)]}),s.jsx("span",{className:"text-xs text-gray-500",children:w(e.created_at).format("hh:mm A")})]})},e.id)),b.map(e=>s.jsx("div",{className:`flex items-start mb-2 ${e.user.username===d.username?"justify-end":""}`,children:s.jsxs("div",{children:[s.jsxs("div",{className:`p-2 rounded-lg ${d.username!==e.user.username?"bg-green-400 text-white rounded-tl-none":"bg-gray-300 text-black rounded-tr-none"}`,children:[s.jsxs("strong",{children:[e.user.username,": "]}),s.jsx("br",{})," ",N(e.message)]}),s.jsx("span",{className:"text-xs text-gray-500",children:w(e.created_at).format("hh:mm A")})]})},e.id)),s.jsx("div",{ref:f})]}),s.jsxs("form",{onSubmit:I,className:"flex space-x-2",children:[s.jsx("input",{type:"text",value:i,onChange:e=>m(e.target.value),placeholder:"Type your message...",className:"flex-grow border p-2 rounded"}),v&&s.jsx("div",{ref:P,className:"absolute top-[31vh] right-[17vw] z-10",style:{width:"300px"},children:s.jsx(V,{onEmojiClick:D})}),s.jsx("div",{className:" cursor-pointer",onClick:C,children:s.jsx(H,{className:"size-6"})}),s.jsx("button",{type:"submit",className:"bg-blue-500 text-white px-4 py-2 rounded",children:"Send"})]})]})})};export{Y as default};
