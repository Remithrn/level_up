import{r as n,b as A,e as H,j as s,p as E,aQ as I}from"./index-DdC0FHAS.js";import{u as O,E as Q,F as W}from"./emoji-picker-react.esm-G0ikEmzM.js";import{h as k}from"./moment-C5S46NFB.js";const U=()=>{var $,_,w,S;const l=n.useRef(null),R=n.useRef(null),[p,b]=n.useState(!1),C=()=>{b(!p)},P=e=>{h(x+e.emoji),b(!1)},j=e=>{const i=/(https?:\/\/[^\s]+)/g;return e.split(" ").map((m,F)=>i.test(m)?s.jsx("a",{href:m,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 underline",children:m},F):m+" ")},{user:u}=A(e=>e.auth),{id:c}=H(),[g,M]=n.useState([]),[y,T]=n.useState([]),d=u==null?void 0:u.pk,[x,h]=n.useState(""),[o,z]=n.useState(null),v=localStorage.getItem("access"),D=async()=>{try{const e=await I.get(`http://localhost/api/chat/${c}/`,{headers:{Authorization:`Bearer ${v}`}});z(e.data),T(e.data.messages)}catch(e){console.error(e,"this is error")}};n.useEffect(()=>{D()},[c]);const t=(_=($=o==null?void 0:o.conversation)==null?void 0:$.users)==null?void 0:_.find(e=>e.id===d),a=(S=(w=o==null?void 0:o.conversation)==null?void 0:w.users)==null?void 0:S.find(e=>e.id!==d),{sendJsonMessage:K,lastJsonMessage:r}=O(`ws://localhost/ws/${c}/?token=${v}`,{share:!0,shouldReconnect:()=>!0}),f=()=>{l.current&&(l.current.scrollTop=l.current.scrollHeight)};n.useEffect(()=>{f()},[y,g]);const B=e=>{e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),N(e))},N=async e=>{e.preventDefault(),x.trim()&&(K({event:"send_message",data:{body:x,name:t==null?void 0:t.username,sent_to_id:a==null?void 0:a.id,conversation_id:c,user:d}}),h(""),f())};return n.useEffect(()=>{r!=null&&r.name&&(r!=null&&r.body)&&(M(e=>[...e,{name:r.name,body:r.body,user:d,timestamp:k().format("h:mm a")}]),f())},[r]),s.jsxs("div",{className:"flex flex-col h-[90vh] border rounded-lg shadow-lg bg-white",children:[a&&s.jsxs("div",{className:"flex items-center p-4 border-b bg-gray-50",children:[s.jsx("img",{src:`http://localhost${a.profile_picture}`,alt:`${a.first_name} ${a.last_name}`,className:"w-12 h-12 rounded-full mr-4"}),s.jsxs("div",{children:[s.jsx("h2",{className:"text-lg font-semibold",children:`${a.first_name} ${a.last_name}`}),s.jsxs("p",{className:"text-sm text-gray-500",children:["@",a.username]})]})]}),s.jsxs("div",{ref:l,className:"flex flex-col space-y-4 overflow-y-auto h-full p-4 bg-gray-100",children:[y.map((e,i)=>s.jsx(E.div,{className:`flex ${e.created_by.id===(t==null?void 0:t.id)?"justify-end":"justify-start"}`,initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.2},children:s.jsxs("div",{className:"flex-none",children:[s.jsx("div",{className:"font-bold text-sm mb-1",children:e.created_by.username}),s.jsxs("div",{className:`p-3 rounded-lg text-start ${e.created_by.id!==(t==null?void 0:t.id)?"bg-green-400 text-white":"bg-gray-200 text-gray-800"} px-4 py-2 rounded-3xl ${e.created_by.id!==(t==null?void 0:t.id)?"rounded-tl-none":"rounded-tr-none"}`,children:[s.jsx("div",{children:j(e.body)}),s.jsx("div",{className:`text-xs mt-1 ${e.created_by.id!==(t==null?void 0:t.id)?"text-blue-200":"text-gray-400"}`,children:k(e.created_at).format("h:mm a")})]})]})},i)),g.map((e,i)=>s.jsx(E.div,{className:`flex ${e.name===(t==null?void 0:t.username)?"justify-end":"justify-start"}`,initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.2},children:s.jsxs("div",{className:"flex-none",children:[s.jsx("div",{className:"font-bold text-sm mb-1",children:e.name}),s.jsxs("div",{className:`p-3 rounded-lg text-start ${e.name!==(t==null?void 0:t.username)?"bg-green-400 text-white":"bg-gray-200 text-gray-800"} px-4 py-2 rounded-3xl ${e.name!==(t==null?void 0:t.username)?"rounded-tl-none":"rounded-tr-none"}`,children:[s.jsx("div",{children:j(e.body)}),s.jsx("div",{className:`text-xs mt-1 ${e.name!==(t==null?void 0:t.username)?"text-blue-200":"text-gray-400"}`,children:e.timestamp})]})]})},i))]}),s.jsxs("form",{onSubmit:N,className:"flex items-center space-x-2 p-4 border-t bg-gray-50",children:[s.jsx("textarea",{value:x,onChange:e=>h(e.target.value),onKeyDown:B,placeholder:"Type your message...",className:"flex-1 px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none",rows:2}),p&&s.jsx("div",{ref:R,className:"absolute top-[31vh] right-[17vw] z-10",style:{width:"300px"},children:s.jsx(Q,{onEmojiClick:P})}),s.jsx("div",{className:" cursor-pointer",onClick:C,children:s.jsx(W,{className:"size-6"})}),s.jsx("button",{type:"submit",className:"px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-all duration-200",children:"Send"})]})]})};export{U as default};
